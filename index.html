<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC Self-Service Portal</title>
    <script src="https://www.google.com/recaptcha/api.js?render=6Ld11zssAAAAAMa8hkYJHz1AWvXuUh_WIfad0zbT"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        select, input[type="email"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .message.show {
            display: block;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }

        .registration-link {
            display: inline-block;
            margin-top: 10px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .registration-link:hover {
            text-decoration: underline;
        }

        /* Honeypot field - hidden from users */
        .honeypot {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
        }

        .recaptcha-notice {
            font-size: 11px;
            color: #999;
            text-align: center;
            margin-top: 15px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ HC Self-Service Portal</h1>
        <p class="subtitle">Heartful Communication Essentials Program</p>

        <div id="message" class="message"></div>

        <form id="portalForm">
            <!-- Honeypot field for bot detection -->
            <input type="text" name="website" class="honeypot" tabindex="-1" autocomplete="off">

            <!-- Step 1: Program Selection -->
            <div class="form-group">
                <label for="program">Select Program *</label>
                <select id="program" name="program" required>
                    <option value="">Loading programs...</option>
                </select>
            </div>

            <!-- Step 2: Email Verification -->
            <div class="form-group">
                <label for="email">Your Email Address *</label>
                <input type="email" id="email" name="email" placeholder="Enter your registered email" required>
                <div id="emailStatus"></div>
            </div>

            <!-- Step 3: Request Selection -->
            <div class="form-group hidden" id="requestsSection">
                <label>Select Your Requests *</label>
                <div id="requestsContainer" class="checkbox-group">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" disabled>Submit Request</button>

            <div class="recaptcha-notice">
                This site is protected by reCAPTCHA and the Google Privacy Policy applies.
            </div>
        </form>
    </div>

    <script>
        /**
         * HC Self-Service Portal - Frontend JavaScript
         * Handles program selection, email verification, request selection, and form submission
         * 
         * Running in Google Apps Script HTML Service (same origin)
         */

        // Configuration
        const CONFIG = {
            // Same origin - use current window location for POST
            API_URL: window.location.href,
            // Replace with your reCAPTCHA v3 Site Key
            RECAPTCHA_SITE_KEY: '6Ld11zssAAAAAMa8hkYJHz1AWvXuUh_WIfad0zbT'
        };

        // State management
        const state = {
            programs: [],
            currentProgram: null,
            isEmailVerified: false,
            requests: []
        };

        // DOM Elements
        const elements = {
            form: document.getElementById('portalForm'),
            programSelect: document.getElementById('program'),
            emailInput: document.getElementById('email'),
            emailStatus: document.getElementById('emailStatus'),
            requestsSection: document.getElementById('requestsSection'),
            requestsContainer: document.getElementById('requestsContainer'),
            submitBtn: document.getElementById('submitBtn'),
            message: document.getElementById('message'),
            honeypot: document.querySelector('.honeypot')
        };

        /**
         * Initialize the portal on page load
         */
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPrograms();
            attachEventListeners();
        });

        /**
         * Attach event listeners to form elements
         */
        function attachEventListeners() {
            elements.programSelect.addEventListener('change', handleProgramChange);
            elements.emailInput.addEventListener('blur', handleEmailVerification);
            elements.form.addEventListener('submit', handleFormSubmit);
        }

        /**
         * Load available programs from the backend
         */
        async function loadPrograms() {
            try {
                showMessage('Loading programs...', 'info');
                
                const response = await makeAPICall('getPrograms');

                if (response.success && response.programs.length > 0) {
                    state.programs = response.programs;
                    populateProgramDropdown(response.programs);
                    hideMessage();
                } else {
                    showMessage('No active programs available at this time.', 'error');
                    elements.programSelect.innerHTML = '<option value="">No programs available</option>';
                }
            } catch (error) {
                showMessage('Error loading programs. Please refresh the page.', 'error');
                console.error('Load programs error:', error);
            }
        }

        /**
         * Populate program dropdown with available programs
         */
        function populateProgramDropdown(programs) {
            elements.programSelect.innerHTML = '<option value="">-- Select a Program --</option>';
            
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program;
                option.textContent = program;
                elements.programSelect.appendChild(option);
            });
        }

        /**
         * Handle program selection change
         */
        function handleProgramChange(event) {
            state.currentProgram = event.target.value;
            
            // Reset state when program changes
            state.isEmailVerified = false;
            elements.emailInput.value = '';
            elements.emailStatus.innerHTML = '';
            elements.requestsSection.classList.add('hidden');
            elements.submitBtn.disabled = true;
            hideMessage();
        }

        /**
         * Handle email verification
         */
        async function handleEmailVerification() {
            const email = elements.emailInput.value.trim();
            const program = state.currentProgram;

            // Clear previous status
            elements.emailStatus.innerHTML = '';
            elements.requestsSection.classList.add('hidden');
            state.isEmailVerified = false;
            elements.submitBtn.disabled = true;

            // Validate inputs
            if (!program) {
                showMessage('Please select a program first.', 'error');
                return;
            }

            if (!email || !isValidEmail(email)) {
                showMessage('Please enter a valid email address.', 'error');
                return;
            }

            try {
                elements.emailStatus.innerHTML = '<p class="loading">Verifying email...</p>';

                const response = await makeAPICall('verifyEmail', {
                    program: program,
                    email: email
                });

                if (response.success) {
                    if (response.registered) {
                        // Email is registered - proceed to load requests
                        state.isEmailVerified = true;
                        elements.emailStatus.innerHTML = '<p style="color: green;">âœ“ Email verified successfully!</p>';
                        await loadRequests(program);
                    } else {
                        // Email not registered
                        state.isEmailVerified = false;
                        
                        if (response.registrationUrl) {
                            // Show registration link
                            elements.emailStatus.innerHTML = `
                                <p style="color: #d68910;">âš  Email not found.</p>
                                <a href="${response.registrationUrl}" target="_blank" class="registration-link">
                                    Click here to register for this program
                                </a>
                            `;
                        } else {
                            // Registration is closed
                            elements.emailStatus.innerHTML = '<p style="color: #d32f2f;">âœ— Email not found and registration is currently closed.</p>';
                        }
                    }
                } else {
                    showMessage(response.message || 'Error verifying email.', 'error');
                }
            } catch (error) {
                showMessage('Error verifying email. Please try again.', 'error');
                console.error('Email verification error:', error);
            }
        }

        /**
         * Load available requests for the selected program
         */
        async function loadRequests(program) {
            try {
                const response = await makeAPICall('getRequests', {
                    program: program
                });

                if (response.success && response.requests.length > 0) {
                    state.requests = response.requests;
                    displayRequests(response.requests);
                    elements.requestsSection.classList.remove('hidden');
                } else {
                    showMessage('No requests available for this program at this time.', 'info');
                }
            } catch (error) {
                showMessage('Error loading requests. Please try again.', 'error');
                console.error('Load requests error:', error);
            }
        }

        /**
         * Display request checkboxes
         */
        function displayRequests(requests) {
            elements.requestsContainer.innerHTML = '';

            requests.forEach((request, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `request-${index}`;
                checkbox.value = request;
                checkbox.name = 'requests';
                checkbox.addEventListener('change', validateForm);

                const label = document.createElement('label');
                label.htmlFor = `request-${index}`;
                label.textContent = request;

                div.appendChild(checkbox);
                div.appendChild(label);
                elements.requestsContainer.appendChild(div);
            });
        }

        /**
         * Validate form and enable/disable submit button
         */
        function validateForm() {
            const selectedRequests = getSelectedRequests();
            elements.submitBtn.disabled = !(state.isEmailVerified && selectedRequests.length > 0);
        }

        /**
         * Get selected requests from checkboxes
         */
        function getSelectedRequests() {
            const checkboxes = document.querySelectorAll('input[name="requests"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        /**
         * Handle form submission
         */
        async function handleFormSubmit(event) {
            event.preventDefault();

            // Check honeypot
            if (elements.honeypot.value !== '') {
                console.warn('Honeypot triggered - potential bot detected');
                showMessage('Submission failed. Please try again.', 'error');
                return;
            }

            const program = state.currentProgram;
            const email = elements.emailInput.value.trim();
            const selectedRequests = getSelectedRequests();

            // Final validation
            if (!program || !email || selectedRequests.length === 0) {
                showMessage('Please complete all required fields.', 'error');
                return;
            }

            try {
                elements.submitBtn.disabled = true;
                elements.submitBtn.textContent = 'Submitting...';

                // Get reCAPTCHA token
                const recaptchaToken = await getRecaptchaToken();

                // Submit to backend
                const response = await makeAPICall('submitRequest', {
                    program: program,
                    email: email,
                    requests: selectedRequests,
                    recaptchaToken: recaptchaToken
                });

                if (response.success) {
                    showMessage('âœ“ Your request has been submitted successfully!', 'success');
                    resetForm();
                } else {
                    showMessage(response.message || 'Submission failed. Please try again.', 'error');
                    elements.submitBtn.disabled = false;
                    elements.submitBtn.textContent = 'Submit Request';
                }
            } catch (error) {
                showMessage('Error submitting request. Please try again.', 'error');
                console.error('Submit error:', error);
                elements.submitBtn.disabled = false;
                elements.submitBtn.textContent = 'Submit Request';
            }
        }

        /**
         * Get reCAPTCHA v3 token
         */
        function getRecaptchaToken() {
            return new Promise((resolve, reject) => {
                try {
                    grecaptcha.ready(() => {
                        grecaptcha.execute(CONFIG.RECAPTCHA_SITE_KEY, { action: 'submit' })
                            .then(token => resolve(token))
                            .catch(error => reject(error));
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }

        /**
         * Make API call to same-origin backend using FormData
         * @param {string} action - Action to perform
         * @param {Object} params - Optional parameters to send
         */
        async function makeAPICall(action, params = {}) {
            // Convert payload to FormData
            const fd = new FormData();
            
            // Add action
            fd.append('action', action);
            
            // Handle arrays specially
            if (params.requests && Array.isArray(params.requests)) {
                params.requests.forEach(req => fd.append('requests', req));
            }
            
            // Add other parameters
            Object.keys(params).forEach(key => {
                if (key !== 'requests') {
                    fd.append(key, params[key]);
                }
            });
            
            // Add honeypot field
            fd.append('honey', '');
            
            // Fetch from same origin - no CORS needed
            // POST to current URL which Apps Script will handle
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                body: fd
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        /**
         * Display message to user
         */
        function showMessage(text, type = 'info') {
            elements.message.textContent = text;
            elements.message.className = `message ${type} show`;
        }

        /**
         * Hide message
         */
        function hideMessage() {
            elements.message.className = 'message';
        }

        /**
         * Validate email format
         */
        function isValidEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        /**
         * Reset form after successful submission
         */
        function resetForm() {
            elements.form.reset();
            elements.requestsSection.classList.add('hidden');
            elements.emailStatus.innerHTML = '';
            state.isEmailVerified = false;
            state.currentProgram = null;
            elements.submitBtn.disabled = true;
            elements.submitBtn.textContent = 'Submit Request';
        }
    </script>
</body>
</html>
